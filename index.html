<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»™å®¶å†›æ±‚ç”Ÿè®°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(30, 30, 60, 0.9);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            color: #ffd54f;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 10px rgba(255, 213, 79, 0.5);
        }

        .game-screen {
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        /* å¼€åœºå±å¹• */
        .story-intro {
            text-align: center;
            line-height: 2;
            margin-bottom: 30px;
        }

        /* è§’è‰²é€‰æ‹© */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .character-card {
            background: rgba(50, 50, 80, 0.8);
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            min-height: 250px;
            display: flex;
            flex-direction: column;
        }

        .character-card:hover {
            transform: translateY(-5px);
            border-color: #ffd54f;
            box-shadow: 0 5px 20px rgba(255, 213, 79, 0.3);
        }

        .character-card.selected {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.2);
        }

        .character-name {
            font-size: 1.3em;
            color: #ffd54f;
            margin-bottom: 10px;
        }

        .character-desc {
            font-size: 0.9em;
            color: #bbb;
            margin-bottom: 10px;
        }

        .character-stats {
            font-size: 0.85em;
            color: #64b5f6;
            margin-bottom: 10px;
        }

        .character-ability {
            color: #4caf50;
            margin-top: auto;
            font-size: 0.85em;
            padding-top: 10px;
            border-top: 1px solid rgba(76, 175, 80, 0.3);
        }

        /* å±æ€§åŠ ç‚¹ */
        .attribute-panel {
            background: rgba(50, 50, 80, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .attribute-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(30, 30, 50, 0.5);
            border-radius: 5px;
        }

        .attribute-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .attr-btn {
            width: 35px;
            height: 35px;
            border: none;
            background: #64b5f6;
            color: white;
            font-size: 1.2em;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .attr-btn:hover {
            background: #42a5f5;
            transform: scale(1.1);
        }

        .attr-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: scale(1);
        }

        .attr-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd54f;
            min-width: 30px;
            text-align: center;
        }

        .points-remaining {
            text-align: center;
            font-size: 1.3em;
            color: #4caf50;
            margin: 20px 0;
        }

        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(30, 30, 60, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            border: 2px solid #ffd54f;
            box-shadow: 0 0 30px rgba(255, 213, 79, 0.5);
        }

        .modal-title {
            font-size: 1.5em;
            color: #ffd54f;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .modal-text {
            font-size: 1.1em;
            color: #64b5f6;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .modal-btn-accept {
            background: #4caf50;
            color: white;
        }

        .modal-btn-accept:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .modal-btn-reject {
            background: #f44336;
            color: white;
            position: relative;
        }

        .modal-btn-reject:hover {
            background: #da190b;
        }

        /* æ¸¸æˆä¸»ç•Œé¢ */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(50, 50, 80, 0.6);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .character-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .current-location {
            text-align: right;
            color: #ffd54f;
            font-weight: bold;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .status-item {
            background: rgba(50, 50, 80, 0.8);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .status-label {
            font-size: 0.9em;
            color: #bbb;
            margin-bottom: 8px;
        }

        .status-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .hp { color: #f44336; }
        .hunger { color: #ff9800; }
        .thirst { color: #2196f3; }
        .attack { color: #e91e63; }
        .defense { color: #9c27b0; }

        /* åœ°ç‚¹å¯¼èˆª */
        .location-nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(50, 50, 80, 0.6);
            border-radius: 8px;
        }

        .location-btn {
            padding: 12px;
            background: rgba(100, 181, 246, 0.3);
            border: 2px solid #64b5f6;
            color: #64b5f6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .location-btn:hover {
            background: rgba(100, 181, 246, 0.6);
            transform: translateY(-2px);
        }

        .location-btn.active {
            background: #64b5f6;
            color: #1a1a2e;
        }

        /* æ¸¸æˆå†…å®¹åŒº */
        .game-content {
            background: rgba(30, 30, 50, 0.7);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            min-height: 300px;
            line-height: 1.8;
            max-height: 500px;
            overflow-y: auto;
        }

        /* æŒ‰é’®åŒº */
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: #4caf50;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #da190b;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #2196f3;
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #0b7dda;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #e68900;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        /* èƒŒåŒ… */
        .inventory {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .item {
            background: rgba(50, 50, 80, 0.8);
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .item:hover {
            border-color: #64b5f6;
            transform: scale(1.05);
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-count {
            color: #ffd54f;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .item-effect {
            color: #4caf50;
            font-size: 0.8em;
            border-top: 1px solid rgba(76, 175, 80, 0.3);
            padding-top: 5px;
            margin-top: 5px;
        }

        /* åˆæˆç•Œé¢ */
        .craft-recipes {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .recipe {
            background: rgba(50, 50, 80, 0.6);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recipe-info {
            flex: 1;
        }

        .recipe-name {
            font-size: 1.1em;
            color: #ffd54f;
            margin-bottom: 5px;
        }

        .recipe-materials {
            font-size: 0.9em;
            color: #bbb;
        }

        /* æˆ˜æ–—ç•Œé¢ */
        .battle-scene {
            text-align: center;
            padding: 20px;
        }

        .enemy-info {
            background: rgba(100, 30, 30, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .enemy-name {
            font-size: 1.5em;
            color: #f44336;
            margin-bottom: 10px;
        }

        .battle-log {
            background: rgba(30, 30, 50, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 250px;
            overflow-y: auto;
            text-align: left;
        }

        .battle-log p {
            margin: 8px 0;
            padding: 5px;
            border-left: 3px solid #64b5f6;
            padding-left: 10px;
        }

        .damage {
            color: #f44336;
        }

        .heal {
            color: #4caf50;
        }

        .info {
            color: #64b5f6;
        }

        /* ç»“å±€ç”»é¢ */
        .ending {
            text-align: center;
            padding: 30px;
            line-height: 2;
        }

        .ending h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .victory {
            color: #4caf50;
        }

        .defeat {
            color: #f44336;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 50, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #64b5f6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #42a5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš”ï¸ ä»™å®¶å†›æ±‚ç”Ÿè®° âš”ï¸</h1>

        <!-- å¼€åœºç•Œé¢ -->
        <div id="intro-screen" class="game-screen active">
            <div class="story-intro">
                <p style="margin-bottom: 20px; font-size: 1.1em;">
                    æ›¾ç»ï¼Œä»™åº­çš„å®¶å›­ç¹è£æ˜Œç››ã€‚ä½†åœ¨ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™šï¼Œ<br>
                    çš±çš®å¤§ç‹ç‡é¢†å¦–é­”å¤§å†›æ‘§æ¯äº†ä»™å®¶å†›çš„ä¸€åˆ‡ã€‚<br>
                    <span style="color: #ffd54f;">æ— æ•°åŒä¼´ä¸§ç”Ÿï¼Œå®¶å›­è¢«å¤·ä¸ºå¹³åœ°...</span><br>
                    <br>
                    <span style="color: #f44336;">ä½ æ˜¯å”¯ä¸€çš„å¹¸å­˜è€…ã€‚</span><br>
                    <span style="color: #ffd54f;">å®¶å›­å·²æ¯ï¼Œå¤ä»‡ä¹‹å¿µç‡ƒçƒ§åœ¨å¿ƒé—´...</span>
                </p>
                <p style="color: #64b5f6; font-size: 0.95em;">é€‰æ‹©ä½ çš„è§’è‰²ï¼Œè¸ä¸Šå¤ä»‡ä¹‹æ—…</p>
            </div>

            <div class="character-grid" id="character-list">
                <!-- è§’è‰²å¡ç‰‡å°†ç”±JSç”Ÿæˆ -->
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="startAttributeAllocation()" id="select-char-btn" disabled>
                    ç¡®è®¤é€‰æ‹©
                </button>
            </div>
        </div>

        <!-- å±æ€§åŠ ç‚¹ç•Œé¢ -->
        <div id="attribute-screen" class="game-screen">
            <h2 style="text-align: center; color: #64b5f6; margin-bottom: 20px;">å±æ€§åŠ ç‚¹</h2>
            <div class="points-remaining">
                å‰©ä½™ç‚¹æ•°: <span id="points-remaining">10</span>
            </div>
            <div class="attribute-panel" id="attribute-panel">
                <!-- å±æ€§åŠ ç‚¹å°†ç”±JSç”Ÿæˆ -->
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="startGame()">
                    å¼€å§‹æ¸¸æˆ
                </button>
            </div>
        </div>

        <!-- ä¸»æ¸¸æˆç•Œé¢ -->
        <div id="game-screen" class="game-screen">
            <!-- æ¸¸æˆå¤´éƒ¨ -->
            <div class="game-header">
                <div class="character-info">
                    <div>
                        <div style="color: #bbb; font-size: 0.9em;">è§’è‰²</div>
                        <div style="color: #ffd54f; font-weight: bold;" id="character-name">è¯¸å¤©æœªæ¥ä»™å¸</div>
                    </div>
                </div>
                <div class="current-location">
                    <div style="color: #bbb; font-size: 0.9em;">å½“å‰ä½ç½®</div>
                    <div id="location-display">âœ¨ ä»™å®¶å†›é—è¿¹</div>
                </div>
            </div>

            <!-- çŠ¶æ€æ  -->
            <div class="status-bar" id="status-bar">
                <div class="status-item">
                    <div class="status-label">ç”Ÿå‘½å€¼</div>
                    <div class="status-value hp" id="hp-display">100/100</div>
                </div>
                <div class="status-item">
                    <div class="status-label">é¥±é£Ÿåº¦</div>
                    <div class="status-value hunger" id="hunger-display">100/100</div>
                </div>
                <div class="status-item">
                    <div class="status-label">é¥¥æ¸´åº¦</div>
                    <div class="status-value thirst" id="thirst-display">100/100</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ”»å‡»åŠ›</div>
                    <div class="status-value attack" id="attack-display">10</div>
                </div>
                <div class="status-item">
                    <div class="status-label">é˜²å¾¡åŠ›</div>
                    <div class="status-value defense" id="defense-display">5</div>
                </div>
            </div>

            <!-- åœ°ç‚¹å¯¼èˆª -->
            <div style="margin-bottom: 15px;">
                <div style="color: #bbb; margin-bottom: 8px;">ğŸ—ºï¸ å¿«é€Ÿä¼ é€</div>
                <div class="location-nav" id="location-nav">
                    <!-- åœ°ç‚¹æŒ‰é’®ç”±JSç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ¸¸æˆå†…å®¹ -->
            <div class="game-content" id="game-content">
                <p>ä½ é†’æ¥æ—¶ï¼Œå‘ç°è‡ªå·±èº«å¤„ä»™å®¶å†›é—è¿¹ä¸­ã€‚æ–­è£‚çš„å®«æ®¿ã€ç„¦é»‘çš„åœŸåœ°ã€å¼¥æ¼«çš„çµæ°”æ··ä¹±...</p>
                <p style="color: #ffd54f; margin-top: 15px;">ä½ éœ€è¦æ”¶é›†èµ„æºã€åˆ¶ä½œæ­¦å™¨ï¼Œé€æ­¥å˜å¼ºï¼Œæœ€ç»ˆæ‰¾åˆ°çš±çš®å¤§ç‹å¤ä»‡ï¼</p>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="actions" id="main-actions">
                <button class="btn btn-info" onclick="explore()">ğŸ” æ¢ç´¢å½“å‰åœ°ç‚¹</button>
                <button class="btn btn-warning" onclick="showInventory()">ğŸ’ èƒŒåŒ…</button>
                <button class="btn btn-info" onclick="showCraft()">ğŸ”¨ åˆæˆ</button>
                <button class="btn btn-primary" onclick="rest()">ğŸ˜´ ä¼‘æ¯</button>
                <button class="btn btn-danger" onclick="findBoss()">âš”ï¸ å¯»æ‰¾çš±çš®å¤§ç‹</button>
            </div>
        </div>

        <!-- èƒŒåŒ…ç•Œé¢ -->
        <div id="inventory-screen" class="game-screen">
            <h2 style="color: #64b5f6; margin-bottom: 20px;">ğŸ“¦ èƒŒåŒ…</h2>
            <div class="inventory" id="inventory-list">
                <!-- ç‰©å“å°†ç”±JSç”Ÿæˆ -->
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-info" onclick="backToGame()">è¿”å›</button>
            </div>
        </div>

        <!-- åˆæˆç•Œé¢ -->
        <div id="craft-screen" class="game-screen">
            <h2 style="color: #64b5f6; margin-bottom: 20px;">ğŸ”¨ åˆæˆå°</h2>
            <div class="craft-recipes" id="craft-recipes">
                <!-- é…æ–¹å°†ç”±JSç”Ÿæˆ -->
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-info" onclick="backToGame()">è¿”å›</button>
            </div>
        </div>

        <!-- æˆ˜æ–—ç•Œé¢ -->
        <div id="battle-screen" class="game-screen">
            <div class="battle-scene">
                <div class="enemy-info">
                    <div class="enemy-name" id="enemy-name">æ•Œäºº</div>
                    <div class="status-value hp" id="enemy-hp">100/100</div>
                </div>
                <div class="battle-log" id="battle-log">
                    <!-- æˆ˜æ–—æ—¥å¿— -->
                </div>
                <div class="actions">
                    <button class="btn btn-danger" onclick="attack()" id="attack-btn">âš”ï¸ æ”»å‡»</button>
                    <button class="btn btn-primary" onclick="useHealItem()" id="heal-btn">ğŸ’Š ä½¿ç”¨æ²»ç–—</button>
                    <button class="btn btn-warning" onclick="flee()" id="flee-btn">ğŸƒ é€ƒè·‘</button>
                </div>
            </div>
        </div>

        <!-- ç»“å±€ç•Œé¢ -->
        <div id="ending-screen" class="game-screen">
            <div class="ending" id="ending-content">
                <!-- ç»“å±€å†…å®¹ç”±JSç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- é™ˆé›¨æ¬£å¼¹çª— -->
    <div id="chenyuxin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ’• é™ˆé›¨æ¬£ ğŸ’•</div>
            <div class="modal-text">
                æˆ‘æ˜¯é™ˆé›¨æ¬£<br>
                æˆ‘å–œæ¬¢ä½ ğŸŒ¹
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-accept" onclick="acceptConfession()">æ¥å—</button>
                <button class="modal-btn modal-btn-reject" id="reject-btn" onclick="rejectConfession()">æ‹’ç»</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®
        const characters = [
            {
                id: 'xiandi',
                name: 'è¯¸å¤©æœªæ¥ä»™å¸',
                desc: 'å¤©èµ‹å¼‚ç¦€ï¼Œä¿®ç‚¼é€Ÿåº¦æå¿«',
                baseStats: { hp: 120, attack: 15, defense: 8 },
                ability: 'æˆ˜æ–—æ—¶æ”»å‡»åŠ›+20%'
            },
            {
                id: 'yangge',
                name: 'æ²³åŒ—å°æ¨',
                desc: 'èº«æ‰‹æ•æ·ï¼Œæ“…é•¿æ¢ç´¢',
                baseStats: { hp: 100, attack: 12, defense: 10 },
                ability: 'æ¢ç´¢æ—¶é¢å¤–è·å¾—èµ„æº'
            },
            {
                id: 'liushipeng',
                name: 'åˆ˜ä¸–é¹',
                desc: 'åŠ›å¤§æ— ç©·ï¼Œé˜²å¾¡æƒŠäºº',
                baseStats: { hp: 150, attack: 10, defense: 15 },
                ability: 'å—åˆ°ä¼¤å®³å‡å°‘30%'
            },
            {
                id: 'chenyuxin',
                name: 'é™ˆé›¨æ¬£',
                desc: 'ç²¾é€šåŒ»æœ¯ï¼Œæ¢å¤èƒ½åŠ›å¼º',
                baseStats: { hp: 90, attack: 8, defense: 7 },
                ability: 'ä½¿ç”¨æ¢å¤ç‰©å“æ•ˆæœ+50%'
            },
            {
                id: 'guilao',
                name: 'é¬¼å§¥',
                desc: 'è¯¡å¼‚è«æµ‹ï¼Œè‡´å‘½ä¸€å‡»',
                baseStats: { hp: 80, attack: 20, defense: 5 },
                ability: '30%æ¦‚ç‡é€ æˆåŒå€ä¼¤å®³'
            },
            {
                id: 'baihu',
                name: 'ç™½ç‹',
                desc: 'çµå·§ç‹¡é» ï¼Œé—ªé¿é«˜è¶…',
                baseStats: { hp: 95, attack: 13, defense: 8 },
                ability: '25%æ¦‚ç‡é—ªé¿æ”»å‡»'
            },
            {
                id: 'shenDun',
                name: 'ç¥ç›¾',
                desc: 'é˜²å¾¡ä¸“å®¶ï¼Œè¶Šæˆ˜è¶Šå¼º',
                baseStats: { hp: 125, attack: 10, defense: 12 },
                ability: 'æ¯å—åˆ°ä¸€æ¬¡ä¼¤å®³ï¼Œæ”»å‡»åŠ›æå‡5%'
            },
            {
                id: 'panSheng',
                name: 'ç›˜åœ£',
                desc: 'åŠ›é‡ä¸é€Ÿåº¦å®Œç¾ç»“åˆ',
                baseStats: { hp: 110, attack: 18, defense: 9 },
                ability: 'æ”»å‡»æ—¶æœ‰æ¦‚ç‡è§¦å‘"éœ‡æœº"ï¼Œæœ¬è½®ä¼¤å®³æé«˜100%'
            },
            {
                id: 'yinglumine',
                name: 'å› æç“¦ç‰¹Â·è§',
                desc: 'æ¥è‡ªå¼‚ä¸–ç•Œçš„æ—…è€…',
                baseStats: { hp: 105, attack: 14, defense: 11 },
                ability: 'å…ƒç´ èåˆï¼šæ”»å‡»æ—¶é€ æˆé¢å¤–30%ä¼¤å®³'
            },
            {
                id: 'datangwanzi',
                name: 'å¤§å”ä¸¸å­',
                desc: 'é£Ÿè´§æˆä»™ï¼Œç¾é£Ÿä¹‹åŠ›',
                baseStats: { hp: 140, attack: 11, defense: 8 },
                ability: 'è¿›é£Ÿæ—¶æ¢å¤ç”Ÿå‘½å€¼+40%'
            }
        ];

        const locations = [
            {
                id: 'ruins',
                name: 'âœ¨ ä»™å®¶å†›é—è¿¹',
                description: 'æ›¾ç»çš„å®¶å›­ç°åœ¨åªå‰©æ–­å£æ®‹å£ã€‚<br>åˆ°å¤„æ˜¯è¢«çƒ§ç„¦çš„ç—•è¿¹ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€æ‚²ä¼¤çš„çµæ°”ã€‚<br>è¿™é‡Œå¯èƒ½è¿˜æœ‰ä¸€äº›æœ‰ç”¨çš„èµ„æº...',
                encounters: ['é‡ç‹¼', 'åºŸå¢Ÿå¹½çµ'],
                resources: ['herb', 'wood', 'stone'],
                story: 'åœ¨åºŸå¢Ÿä¸­ï¼Œä½ å‘ç°äº†ä¸€å—å¸¦æœ‰ä»™å®¶å†›æ ‡è®°çš„ç¢ç‰‡ã€‚<br>è¿™å‹¾èµ·äº†ä½ å¯¹é‚£äº›å¤±å»çš„åŒä¼´çš„å›å¿†...'
            },
            {
                id: 'forest',
                name: 'ğŸŒ² è¯¡å¼‚æ ‘æ—',
                description: 'è¿™ç‰‡æ ‘æ—è¢«å¦–æ°”æ±¡æŸ“ï¼Œæ ‘æœ¨æ‰­æ›²å˜å½¢ã€‚<br>å¯ä»¥å¬åˆ°å¥‡å¼‚çš„å£°éŸ³åœ¨æ—é—´å›è¡ã€‚<br>è¿™é‡Œå¯èƒ½éšè—ç€å˜å¼‚çš„å¦–å…½...',
                encounters: ['å˜å¼‚é‡ç‹¼', 'å¦–æ ‘ç²¾çµ'],
                resources: ['wood', 'herb', 'meat'],
                story: 'æ·±å…¥æ ‘æ—æ·±å¤„ï¼Œä½ å‘ç°äº†ä¸€ä¸ªè¢«é—å¼ƒçš„è¥åœ°ã€‚<br>è¿™æ˜¯ä»™å®¶å†›æ’¤é€€æ—¶ç•™ä¸‹çš„ã€‚é‡Œé¢è¿˜æœ‰ä¸€äº›é£Ÿç‰©...'
            },
            {
                id: 'swamp',
                name: 'ğŸœï¸ è¯¡å¼‚æ²¼æ³½',
                description: 'ä¸€ç‰‡æ³¥æ³çš„æ²¼æ³½åœ°ï¼Œæ•£å‘ç€åˆºé¼»çš„æ°”å‘³ã€‚<br>æ²¼æ³½ä¸­å……æ»¡äº†æ¯’æ°”å’Œå±é™©çš„ç”Ÿç‰©ã€‚<br>è¿™é‡Œæœ‰å……è¶³çš„æ°´æºï¼Œä½†ä¹Ÿéšè—ç€æœªçŸ¥çš„å±é™©...',
                encounters: ['æ²¼æ³½æ¯’è›™', 'æ³¥æµ†æ€ªç‰©'],
                resources: ['water', 'herb', 'wood'],
                story: 'åœ¨æ²¼æ³½ä¸­å¿ƒï¼Œä½ å‘ç°äº†ä¸€å£æ¸…æ°´äº•ã€‚<br>è¿™æ˜¯ä¸€ä¸ªå®è´µçš„èµ„æºç‚¹ï¼Œèƒ½è¡¥å……å¤§é‡çš„æ°´...'
            },
            {
                id: 'cooldog',
                name: 'ğŸ• é…·çŠ¬å±±',
                description: 'ä¸€åº§é™¡å³­çš„å±±å³°ï¼Œå±±ä¸Šä½ç€è®¸å¤šå‡¶æ‚çš„çŒ›å…½ã€‚<br>è¿™é‡Œçš„ç”Ÿç‰©éƒ½å¼‚å¸¸å‡¶æ®‹ï¼Œä½†èµ„æºä¹Ÿæå…¶ä¸°å¯Œã€‚<br>å¬è¯´è¿˜æœ‰ä¸€åªç‰¹åˆ«çš„æ€ªç‰©åœ¨è¿™é‡Œæ´»åŠ¨...',
                encounters: ['é‡ç”ŸçŠ¬å…½', 'é…·é…·çš„ç‹—'],
                resources: ['meat', 'stone', 'iron'],
                story: 'åœ¨å±±é¡¶ï¼Œä½ é‡è§äº†ä¸€åªä½“å‹å·¨å¤§ã€æ¯›å‘é£˜é€¸çš„é…·é…·çš„ç‹—ã€‚<br>å®ƒä¼¼ä¹åœ¨å®ˆæŠ¤ä»€ä¹ˆä¸œè¥¿...'
            },
            {
                id: 'company',
                name: 'ğŸ¢ æ¶é­”å…¬å¸',
                description: 'ä¸€åº§è¯¡å¼‚çš„ç°ä»£å»ºç­‘çŸ—ç«‹åœ¨è’é‡ä¸­ã€‚<br>è¿™æ˜¯çš±çš®å¤§ç‹çš„æ®ç‚¹ï¼Œå……æ»¡äº†é‚ªæ¶çš„æ°”æ¯ã€‚<br>è¿™é‡Œæ±‡é›†äº†è®¸å¤šå¼ºå¤§çš„æ€ªç‰©...',
                encounters: ['å…¬å¸å‘˜å·¥', 'å¦–æ€ªä¸»ç®¡', 'é‚ªçµä¿å®‰'],
                resources: ['iron', 'stone', 'potion'],
                story: 'ä½ æ½œå…¥äº†æ¶é­”å…¬å¸ã€‚åœ¨æ¡£æ¡ˆå®¤ä¸­å‘ç°äº†çš±çš®å¤§ç‹çš„è®¡åˆ’ã€‚<br>å®ƒè®¡åˆ’è¿›ä¸€æ­¥æ‰©å¼ å…¶åŠ¿åŠ›èŒƒå›´ï¼Œæ‘§æ¯æ›´å¤šçš„åŠ¿åŠ›...'
            },
            {
                id: 'cave',
                name: 'â›°ï¸ æ·±æ¸Šæ´çªŸ',
                description: 'ä¸€ä¸ªæ·±ä¸è§åº•çš„é»‘æš—æ´çªŸã€‚<br>é‡Œé¢ä¼ æ¥ä½æ²‰çš„å¼å£°å’Œå¥‡å¼‚çš„æ°”å‘³ã€‚<br>æ®è¯´çš±çš®å¤§ç‹çš„ä¸€äº›æ‰‹ä¸‹åœ¨è¿™é‡Œä¿®è¡Œ...',
                encounters: ['æ´çªŸèœ˜è››', 'åœ°ç©´æ¶é­”'],
                resources: ['iron', 'herb', 'stone'],
                story: 'åœ¨æ´çªŸæ·±å¤„ï¼Œä½ æ‰¾åˆ°äº†ä¸€ä¸ªè¢«å›°çš„ç”Ÿçµã€‚<br>å®ƒå‘Šè¯‰ä½ çš±çš®å¤§ç‹çš„å¼±ç‚¹ä¿¡æ¯...'
            },
            {
                id: 'temple',
                name: 'ğŸ¯ åºŸå¼ƒç¥åº™',
                description: 'ä¸€åº§å¤è€çš„ç¥åº™è¢«å²æœˆä¾µèš€ã€‚<br>è¿™é‡Œæ›¾ç»æ˜¯äººç±»æ±‚ç¥çš„åœ°æ–¹ï¼Œç°åœ¨æ²¦ä¸ºäº†å¦–æ€ªçš„å·¢ç©´ã€‚<br>ä½†ä¹Ÿè®¸è¿˜èƒ½æ‰¾åˆ°ä¸€äº›çè´µçš„é—ç‰©...',
                encounters: ['ç¥åº™å®ˆå«', 'å •è½åƒ§ä¾£'],
                resources: ['potion', 'herb', 'wood'],
                story: 'åœ¨ç¥åº™çš„åœ°ä¸‹å®¤ï¼Œä½ å‘ç°äº†ä¸€æœ¬è®°è½½ä»™å®¶å†›å†å²çš„å¤ç±ã€‚<br>å…¶ä¸­æåˆ°äº†ä¸€ä¸ªèƒ½å¤Ÿå‰Šå¼±çš±çš®å¤§ç‹çš„æ–¹æ³•...'
            },
            {
                id: 'fortress',
                name: 'ğŸ‘‘ æ°¸å¤œå ¡å’',
                description: 'çš±çš®å¤§ç‹çš„æœ€ç»ˆæ®ç‚¹ï¼<br>è¿™åº§å ¡å’å……æ»¡äº†ç»æœ›çš„é»‘æš—åŠ›é‡ã€‚<br>åªæœ‰åšå¥½å……è¶³å‡†å¤‡çš„äººæ‰èƒ½åœ¨è¿™é‡Œæ´»ä¸‹æ¥...',
                encounters: ['çš±çš®å¤§ç‹'],
                resources: [],
                story: 'è¿™å°±æ˜¯å¤ä»‡çš„ç»ˆç‚¹ã€‚åœ¨è¿™é‡Œï¼Œä½ å°†é¢å¯¹ä½ æœ€å¼ºå¤§çš„æ•Œäºº...'
            }
        ];

        const items = {
            food: { 
                name: 'é£Ÿç‰©', 
                hunger: 30, 
                thirst: 0,
                effect: 'æ¢å¤30é¥±é£Ÿåº¦'
            },
            water: { 
                name: 'æ¸…æ°´', 
                hunger: 0, 
                thirst: 40,
                effect: 'æ¢å¤40é¥¥æ¸´åº¦'
            },
            meat: { 
                name: 'çƒ¤è‚‰', 
                hunger: 50, 
                thirst: -10,
                effect: 'æ¢å¤50é¥±é£Ÿåº¦ï¼Œå‡å°‘10é¥¥æ¸´åº¦'
            },
            herb: { 
                name: 'è‰è¯', 
                hp: 30,
                effect: 'æ¢å¤30ç”Ÿå‘½å€¼'
            },
            potion: { 
                name: 'æ²»ç–—è¯æ°´', 
                hp: 60,
                effect: 'æ¢å¤60ç”Ÿå‘½å€¼'
            },
            wood: { 
                name: 'æœ¨æ', 
                craftMaterial: true,
                effect: 'åˆæˆææ–™'
            },
            stone: { 
                name: 'çŸ³å¤´', 
                craftMaterial: true,
                effect: 'åˆæˆææ–™'
            },
            iron: { 
                name: 'é“çŸ¿', 
                craftMaterial: true,
                effect: 'åˆæˆææ–™'
            },
            soul_fragment: { 
                name: 'çµé­‚ç¢ç‰‡', 
                special: true, 
                description: 'çš±çš®å¤§ç‹çš„åŠ›é‡æ¥æºä¹‹ä¸€',
                effect: 'åˆæˆä¼ å¥‡æ­¦å™¨'
            }
        };

        const recipes = [
            {
                name: 'æœ¨æ£',
                materials: { wood: 2 },
                result: { attack: 5, defense: 0 },
                desc: 'ç®€æ˜“æ­¦å™¨ï¼Œå¢åŠ 5ç‚¹æ”»å‡»'
            },
            {
                name: 'çŸ³æ–§',
                materials: { wood: 2, stone: 3 },
                result: { attack: 12, defense: 0 },
                desc: 'åšå›ºæ­¦å™¨ï¼Œå¢åŠ 12ç‚¹æ”»å‡»'
            },
            {
                name: 'é“å‰‘',
                materials: { wood: 1, iron: 5 },
                result: { attack: 25, defense: 0 },
                desc: 'é”‹åˆ©æ­¦å™¨ï¼Œå¢åŠ 25ç‚¹æ”»å‡»'
            },
            {
                name: 'æœ¨ç›¾',
                materials: { wood: 4 },
                result: { attack: 0, defense: 8 },
                desc: 'é˜²æŠ¤è£…å¤‡ï¼Œå¢åŠ 8ç‚¹é˜²å¾¡'
            },
            {
                name: 'é“ç”²',
                materials: { iron: 8, stone: 3 },
                result: { attack: 0, defense: 20 },
                desc: 'åšå›ºæŠ¤ç”²ï¼Œå¢åŠ 20ç‚¹é˜²å¾¡'
            },
            {
                name: 'æ²»ç–—è¯æ°´',
                materials: { herb: 3, water: 1 },
                result: { item: 'potion' },
                desc: 'æ¢å¤60ç‚¹ç”Ÿå‘½å€¼'
            },
            {
                name: 'ç¥åœ£ä¹‹å‰‘',
                materials: { iron: 10, soul_fragment: 2 },
                result: { attack: 40, defense: 0 },
                desc: 'ä¼ å¥‡æ­¦å™¨ï¼Œèƒ½å¯¹çš±çš®å¤§ç‹é€ æˆåŒå€ä¼¤å®³'
            }
        ];

        const enemies = {
            'é‡ç‹¼': { hp: 40, attack: 8, defense: 3, reward: ['food', 'wood'], location: 'ruins' },
            'å˜å¼‚é‡ç‹¼': { hp: 60, attack: 12, defense: 5, reward: ['meat', 'wood', 'herb'], location: 'forest' },
            'å¦–æ ‘ç²¾çµ': { hp: 70, attack: 10, defense: 8, reward: ['herb', 'potion'], location: 'forest' },
            'åºŸå¢Ÿå¹½çµ': { hp: 50, attack: 14, defense: 4, reward: ['herb', 'stone'], location: 'ruins' },
            'æ²¼æ³½æ¯’è›™': { hp: 55, attack: 11, defense: 6, reward: ['water', 'herb'], location: 'swamp' },
            'æ³¥æµ†æ€ªç‰©': { hp: 80, attack: 13, defense: 7, reward: ['water', 'stone', 'herb'], location: 'swamp' },
            'é‡ç”ŸçŠ¬å…½': { hp: 75, attack: 14, defense: 6, reward: ['meat', 'stone'], location: 'cooldog' },
            'é…·é…·çš„ç‹—': { hp: 150, attack: 25, defense: 15, reward: ['meat', 'iron', 'soul_fragment'], location: 'cooldog', boss: true },
            'å…¬å¸å‘˜å·¥': { hp: 60, attack: 12, defense: 6, reward: ['iron', 'stone', 'potion'], location: 'company' },
            'å¦–æ€ªä¸»ç®¡': { hp: 100, attack: 18, defense: 10, reward: ['iron', 'soul_fragment'], location: 'company' },
            'é‚ªçµä¿å®‰': { hp: 80, attack: 15, defense: 8, reward: ['stone', 'potion'], location: 'company' },
            'æ´çªŸèœ˜è››': { hp: 75, attack: 16, defense: 6, reward: ['iron', 'herb'], location: 'cave' },
            'åœ°ç©´æ¶é­”': { hp: 120, attack: 20, defense: 12, reward: ['iron', 'soul_fragment', 'potion'], location: 'cave' },
            'ç¥åº™å®ˆå«': { hp: 90, attack: 17, defense: 10, reward: ['potion', 'herb', 'soul_fragment'], location: 'temple' },
            'å •è½åƒ§ä¾£': { hp: 85, attack: 14, defense: 9, reward: ['herb', 'potion'], location: 'temple' }
        };

        const bossEnemy = {
            name: 'çš±çš®å¤§ç‹',
            hp: 500,
            maxHp: 500,
            attack: 35,
            defense: 25,
            specialAttack: true
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            selectedCharacter: null,
            currentLocation: 'ruins',
            player: {
                name: '',
                hp: 100,
                maxHp: 100,
                hunger: 100,
                maxHunger: 100,
                thirst: 100,
                maxThirst: 100,
                baseAttack: 10,
                baseDefense: 5,
                bonusAttack: 0,
                bonusDefense: 0,
                ability: '',
                attributes: {
                    strength: 0,
                    vitality: 0,
                    endurance: 0,
                    agility: 0
                },
                attackBoost: 0,  // ç¥ç›¾ç”¨ï¼šå—ä¼¤æ—¶æ”»å‡»åŠ›æå‡
                isZhenJi: false  // ç›˜åœ£ç”¨ï¼šæ˜¯å¦è§¦å‘éœ‡æœº
            },
            inventory: {},
            currentEnemy: null,
            inBattle: false,
            battleEnded: false,
            turnsAlived: 0,
            bossDefeated: false,
            visitedLocations: new Set(),
            storyProgress: 0,
            savedAlly: false,
            defeatedCoolDog: false
        };

        let attributePoints = 10;

        // åˆå§‹åŒ–è§’è‰²é€‰æ‹©
        function initCharacterSelection() {
            const characterList = document.getElementById('character-list');
            characterList.innerHTML = '';
            
            characters.forEach(char => {
                const card = document.createElement('div');
                card.className = 'character-card';
                card.onclick = () => selectCharacter(char.id);
                card.id = `char-${char.id}`;
                card.innerHTML = `
                    <div>
                        <div class="character-name">${char.name}</div>
                        <div class="character-desc">${char.desc}</div>
                        <div class="character-stats">
                            ç”Ÿå‘½: ${char.baseStats.hp} | 
                            æ”»å‡»: ${char.baseStats.attack} | 
                            é˜²å¾¡: ${char.baseStats.defense}
                        </div>
                    </div>
                    <div class="character-ability">
                        â­ ${char.ability}
                    </div>
                `;
                characterList.appendChild(card);
            });
        }

        // é€‰æ‹©è§’è‰²
        function selectCharacter(charId) {
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`char-${charId}`).classList.add('selected');
            
            gameState.selectedCharacter = characters.find(c => c.id === charId);
            document.getElementById('select-char-btn').disabled = false;
        }

        // å¼€å§‹å±æ€§åŠ ç‚¹
        function startAttributeAllocation() {
            if (!gameState.selectedCharacter) return;
            
            // âœ… é™ˆé›¨æ¬£ç‰¹æ®Šå¤„ç†
            if (gameState.selectedCharacter.id === 'chenyuxin') {
                document.getElementById('chenyuxin-modal').classList.add('active');
                return;
            }
            
            document.getElementById('intro-screen').classList.remove('active');
            document.getElementById('attribute-screen').classList.add('active');
            
            initAttributePanel();
        }

        // âœ… æ¥å—å‘Šç™½
        function acceptConfession() {
            document.getElementById('chenyuxin-modal').classList.remove('active');
            document.getElementById('intro-screen').classList.remove('active');
            document.getElementById('attribute-screen').classList.add('active');
            
            initAttributePanel();
        }

        // âœ… æ‹’ç»å‘Šç™½ - å¼¹çª—ç¬ç§»
        function rejectConfession() {
            const modal = document.getElementById('chenyuxin-modal');
            const rejectBtn = document.getElementById('reject-btn');
            
            // ç”Ÿæˆéšæœºä½ç½®
            const randomX = Math.random() * (window.innerWidth - 100);
            const randomY = Math.random() * (window.innerHeight - 50);
            
            rejectBtn.style.position = 'fixed';
            rejectBtn.style.left = randomX + 'px';
            rejectBtn.style.top = randomY + 'px';
            rejectBtn.style.zIndex = '1001';
        }

        // åˆå§‹åŒ–å±æ€§é¢æ¿
        function initAttributePanel() {
            const panel = document.getElementById('attribute-panel');
            const attrs = ['strength', 'åŠ›é‡ (æ”»å‡»+2)', 'vitality', 'ä½“è´¨ (ç”Ÿå‘½+10)', 'endurance', 'è€åŠ› (é˜²å¾¡+2)', 'agility', 'æ•æ· (é—ªé¿+2%)'];
            
            panel.innerHTML = '';
            for (let i = 0; i < attrs.length; i += 2) {
                const attrKey = attrs[i];
                const attrName = attrs[i + 1];
                
                const item = document.createElement('div');
                item.className = 'attribute-item';
                item.innerHTML = `
                    <span>${attrName}</span>
                    <div class="attribute-controls">
                        <button class="attr-btn" onclick="decreaseAttr('${attrKey}')">-</button>
                        <span class="attr-value" id="attr-${attrKey}">0</span>
                        <button class="attr-btn" onclick="increaseAttr('${attrKey}')">+</button>
                    </div>
                `;
                panel.appendChild(item);
            }
            
            updateAttributeDisplay();
        }

        // å¢åŠ å±æ€§
        function increaseAttr(attr) {
            if (attributePoints > 0) {
                gameState.player.attributes[attr]++;
                attributePoints--;
                updateAttributeDisplay();
            }
        }

        // å‡å°‘å±æ€§
        function decreaseAttr(attr) {
            if (gameState.player.attributes[attr] > 0) {
                gameState.player.attributes[attr]--;
                attributePoints++;
                updateAttributeDisplay();
            }
        }

        // æ›´æ–°å±æ€§æ˜¾ç¤º
        function updateAttributeDisplay() {
            document.getElementById('points-remaining').textContent = attributePoints;
            
            for (let attr in gameState.player.attributes) {
                document.getElementById(`attr-${attr}`).textContent = gameState.player.attributes[attr];
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            const char = gameState.selectedCharacter;
            const attrs = gameState.player.attributes;
            
            gameState.player.name = char.name;
            gameState.player.maxHp = char.baseStats.hp + attrs.vitality * 10;
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.baseAttack = char.baseStats.attack + attrs.strength * 2;
            gameState.player.baseDefense = char.baseStats.defense + attrs.endurance * 2;
            gameState.player.ability = char.ability;
            gameState.player.agility = attrs.agility * 2;
            
            gameState.inventory = {
                food: 3,
                water: 3,
                herb: 2,
                wood: 5,
                stone: 2
            };
            
            document.getElementById('attribute-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            initLocationButtons();
            updateStatusBar();
            updateCharacterDisplay();
            addGameLog('æ¸¸æˆå¼€å§‹ï¼ä½ åœ¨ä»™å®¶å†›çš„é—è¿¹ä¸­é†’æ¥...');
            addGameLog('ä½ éœ€è¦å˜å¼ºï¼Œæ‰¾åˆ°çš±çš®å¤§ç‹å¤ä»‡ï¼');
        }

        // åˆå§‹åŒ–åœ°ç‚¹æŒ‰é’®
        function initLocationButtons() {
            const nav = document.getElementById('location-nav');
            nav.innerHTML = '';
            
            locations.forEach(loc => {
                const btn = document.createElement('button');
                btn.className = 'location-btn';
                if (loc.id === gameState.currentLocation) {
                    btn.classList.add('active');
                }
                btn.textContent = loc.name;
                btn.onclick = () => travelToLocation(loc.id);
                nav.appendChild(btn);
            });
        }

        // æ—…è¡Œåˆ°åœ°ç‚¹
        function travelToLocation(locationId) {
            gameState.currentLocation = locationId;
            gameState.turnsAlived++;
            gameState.visitedLocations.add(locationId);
            
            const location = locations.find(l => l.id === locationId);
            const content = document.getElementById('game-content');
            
            content.innerHTML = '';
            
            addGameLog(`ğŸ“ ä½ æ¥åˆ°äº† ${location.name}`);
            addGameLog(location.description);
            
            if (locationId === 'company' && !gameState.savedAlly) {
                addGameLog(`<div style="background: rgba(50, 50, 80, 0.95); padding: 15px; border-radius: 8px; border-left: 4px solid #ffd54f;">
                    <div style="font-size: 1.2em; color: #ffd54f; margin-bottom: 10px;">âš ï¸ å‘ç°å¼‚çŠ¶</div>
                    ${location.story}
                </div>`);
                gameState.savedAlly = true;
            }
            
            gameState.player.hunger -= 3;
            gameState.player.thirst -= 5;
            
            updateStatusBar();
            updateLocationDisplay();
            initLocationButtons();
            checkSurvival();
        }

        // æ›´æ–°ä½ç½®æ˜¾ç¤º
        function updateLocationDisplay() {
            const location = locations.find(l => l.id === gameState.currentLocation);
            document.getElementById('location-display').textContent = location.name;
        }

        // æ›´æ–°è§’è‰²æ˜¾ç¤º
        function updateCharacterDisplay() {
            document.getElementById('character-name').textContent = gameState.player.name;
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatusBar() {
            const p = gameState.player;
            document.getElementById('hp-display').textContent = `${Math.max(0, p.hp)}/${p.maxHp}`;
            document.getElementById('hunger-display').textContent = `${Math.max(0, p.hunger)}/${p.maxHunger}`;
            document.getElementById('thirst-display').textContent = `${Math.max(0, p.thirst)}/${p.maxThirst}`;
            
            const totalAttack = p.baseAttack + p.bonusAttack + p.attackBoost;
            const totalDefense = p.baseDefense + p.bonusDefense;
            
            document.getElementById('attack-display').textContent = totalAttack;
            document.getElementById('defense-display').textContent = totalDefense;
            
            if (p.hp <= 0) {
                gameOver(false);
            }
        }

        // æ·»åŠ æ¸¸æˆæ—¥å¿—
        function addGameLog(message) {
            const content = document.getElementById('game-content');
            const p = document.createElement('p');
            p.innerHTML = message;
            p.style.marginTop = '10px';
            content.appendChild(p);
            content.scrollTop = content.scrollHeight;
        }

        // æ¢ç´¢
        function explore() {
            gameState.turnsAlived++;
            
            gameState.player.hunger -= 5;
            gameState.player.thirst -= 8;
            
            const location = locations.find(l => l.id === gameState.currentLocation);
            const rand = Math.random();
            
            if (rand < 0.4) {
                const resources = location.resources;
                const foundResource = resources[Math.floor(Math.random() * resources.length)];
                let amount = Math.floor(Math.random() * 3) + 1;
                
                if (gameState.player.name === 'æ²³åŒ—å°æ¨') {
                    amount = Math.floor(amount * 1.5);
                }
                
                addToInventory(foundResource, amount);
                addGameLog(`ğŸ‰ æ¢ç´¢æˆåŠŸï¼ä½ å‘ç°äº† ${items[foundResource].name} x${amount}`);
            } else if (rand < 0.7) {
                startBattle(location);
            } else {
                addGameLog('ä½ åœ¨ ' + location.name + ' ä¸­æœç´¢ï¼Œä½†ä»€ä¹ˆéƒ½æ²¡æ‰¾åˆ°...');
            }
            
            updateStatusBar();
            checkSurvival();
        }

        // æ˜¾ç¤ºèƒŒåŒ…
        function showInventory() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('inventory-screen').classList.add('active');
            
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            
            if (Object.keys(gameState.inventory).length === 0) {
                inventoryList.innerHTML = '<p style="text-align: center; color: #bbb;">èƒŒåŒ…æ˜¯ç©ºçš„</p>';
                return;
            }
            
            for (let itemId in gameState.inventory) {
                if (gameState.inventory[itemId] > 0) {
                    const item = items[itemId];
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.onclick = () => useItem(itemId);
                    div.innerHTML = `
                        <div class="item-name">${item.name}</div>
                        <div class="item-count">x${gameState.inventory[itemId]}</div>
                        <div class="item-effect">${item.effect}</div>
                    `;
                    inventoryList.appendChild(div);
                }
            }
        }

        // ä½¿ç”¨ç‰©å“
        function useItem(itemId) {
            if (!gameState.inventory[itemId] || gameState.inventory[itemId] <= 0) {
                return;
            }
            
            const item = items[itemId];
            
            if (item.craftMaterial || item.special) {
                addGameLog(`${item.name} ä¸èƒ½ç›´æ¥ä½¿ç”¨`);
                return;
            }
            
            let used = false;
            let message = '';
            
            if (item.hp) {
                let healAmount = item.hp;
                if (gameState.player.name === 'é™ˆé›¨æ¬£') {
                    healAmount = Math.floor(healAmount * 1.5);
                }
                // âœ… å¤§å”ä¸¸å­ç‰¹æ®Šèƒ½åŠ›
                if (gameState.player.name === 'å¤§å”ä¸¸å­' && itemId === 'meat') {
                    healAmount = Math.floor(healAmount * 1.4);
                }
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                message = `ä½¿ç”¨äº† ${item.name}ï¼Œæ¢å¤äº† ${healAmount} ç‚¹ç”Ÿå‘½å€¼`;
                used = true;
            }
            
            if (item.hunger && item.hunger > 0) {
                gameState.player.hunger = Math.min(gameState.player.maxHunger, gameState.player.hunger + item.hunger);
                if (message) message += 'ï¼Œ';
                message += `æ¢å¤äº†${item.hunger}é¥±é£Ÿåº¦`;
                used = true;
            }
            
            if (item.thirst && item.thirst > 0) {
                gameState.player.thirst = Math.min(gameState.player.maxThirst, gameState.player.thirst + item.thirst);
                if (message) message += 'ï¼Œ';
                message += `æ¢å¤äº†${item.thirst}é¥¥æ¸´åº¦`;
                used = true;
            }
            
            if (used) {
                gameState.inventory[itemId]--;
                addGameLog(`âœ… ${message}`);
                updateStatusBar();
                showInventory();
            }
        }

        // æ˜¾ç¤ºåˆæˆç•Œé¢
        function showCraft() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('craft-screen').classList.add('active');
            
            const recipesList = document.getElementById('craft-recipes');
            recipesList.innerHTML = '';
            
            recipes.forEach((recipe, index) => {
                const canCraft = checkCanCraft(recipe);
                const div = document.createElement('div');
                div.className = 'recipe';
                
                let materialsText = '';
                for (let mat in recipe.materials) {
                    const need = recipe.materials[mat];
                    const have = gameState.inventory[mat] || 0;
                    materialsText += `${items[mat].name}: ${have}/${need} `;
                }
                
                div.innerHTML = `
                    <div class="recipe-info">
                        <div class="recipe-name">${recipe.name}</div>
                        <div class="recipe-materials">ææ–™: ${materialsText}</div>
                        <div style="color: #64b5f6; font-size: 0.85em; margin-top: 5px;">${recipe.desc}</div>
                    </div>
                    <button class="btn ${canCraft ? 'btn-primary' : 'btn-disabled'}" 
                            onclick="craft(${index})" 
                            ${canCraft ? '' : 'disabled'}>
                        åˆæˆ
                    </button>
                `;
                recipesList.appendChild(div);
            });
        }

        // æ£€æŸ¥èƒ½å¦åˆæˆ
        function checkCanCraft(recipe) {
            for (let mat in recipe.materials) {
                if (!gameState.inventory[mat] || gameState.inventory[mat] < recipe.materials[mat]) {
                    return false;
                }
            }
            return true;
        }

        // åˆæˆç‰©å“
        function craft(recipeIndex) {
            const recipe = recipes[recipeIndex];
            
            if (!checkCanCraft(recipe)) {
                return;
            }
            
            for (let mat in recipe.materials) {
                gameState.inventory[mat] -= recipe.materials[mat];
            }
            
            if (recipe.result.item) {
                addToInventory(recipe.result.item, 1);
                addGameLog(`ğŸ”¨ æˆåŠŸåˆæˆäº† ${items[recipe.result.item].name}ï¼`);
            } else {
                if (recipe.result.attack) {
                    gameState.player.bonusAttack += recipe.result.attack;
                    addGameLog(`ğŸ”¨ æˆåŠŸåˆæˆäº† ${recipe.name}ï¼æ”»å‡»åŠ› +${recipe.result.attack}`);
                }
                if (recipe.result.defense) {
                    gameState.player.bonusDefense += recipe.result.defense;
                    addGameLog(`ğŸ”¨ æˆåŠŸåˆæˆäº† ${recipe.name}ï¼é˜²å¾¡åŠ› +${recipe.result.defense}`);
                }
            }
            
            updateStatusBar();
            showCraft();
        }

        // ä¼‘æ¯
        function rest() {
            gameState.turnsAlived++;
            
            const healAmount = Math.floor(gameState.player.maxHp * 0.3);
            gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
            gameState.player.hunger -= 10;
            gameState.player.thirst -= 10;
            
            addGameLog(`ğŸ˜´ ä½ åœ¨ ${locations.find(l => l.id === gameState.currentLocation).name} ä¼‘æ¯äº†ï¼Œæ¢å¤äº† ${healAmount} ç‚¹ç”Ÿå‘½å€¼`);
            updateStatusBar();
            checkSurvival();
        }

        // å¯»æ‰¾Boss
        function findBoss() {
            if (gameState.bossDefeated) {
                addGameLog('çš±çš®å¤§ç‹å·²ç»è¢«ä½ æ¶ˆç­äº†ï¼');
                return;
            }
            
            const totalPower = gameState.player.baseAttack + gameState.player.bonusAttack + 
                              gameState.player.baseDefense + gameState.player.bonusDefense;
            
            if (totalPower < 50) {
                addGameLog('âš ï¸ ä½ æ„Ÿè§‰è‡ªå·±è¿˜ä¸å¤Ÿå¼ºå¤§ï¼Œéœ€è¦æ›´å¤šçš„è£…å¤‡å’Œå‡†å¤‡...');
                addGameLog('ğŸ’¡ æç¤º: éœ€è¦æ€»æˆ˜åŠ›è¾¾åˆ°50ä»¥ä¸Šï¼');
                return;
            }
            
            if (gameState.player.hp < gameState.player.maxHp * 0.5) {
                addGameLog('âš ï¸ ä½ çš„çŠ¶æ€ä¸å¤ªå¥½ï¼Œåº”è¯¥å…ˆæ²»ç–—ä¸€ä¸‹...');
                return;
            }
            
            addGameLog('ä½ å†³å®šå‘æ°¸å¤œå ¡å’å‰è¿›...');
            addGameLog('å¤©ç©ºå˜å¾—è¶Šæ¥è¶Šé»‘ï¼Œé‚ªæ¶çš„åŠ›é‡ç¬¼ç½©ç€å¤§åœ°...');
            addGameLog('ä½ æ‰¾åˆ°äº†é€šå¾€æ°¸å¤œå ¡å’çš„å…¥å£ï¼');
            setTimeout(() => {
                startBossBattle();
            }, 1000);
        }

        // å¼€å§‹æ™®é€šæˆ˜æ–—
        function startBattle(location) {
            const enemyNames = location.encounters;
            const enemyName = enemyNames[Math.floor(Math.random() * enemyNames.length)];
            const enemy = JSON.parse(JSON.stringify(enemies[enemyName]));
            enemy.maxHp = enemy.hp;
            gameState.currentEnemy = enemy;
            gameState.inBattle = true;
            gameState.battleEnded = false;
            gameState.player.isZhenJi = false;
            
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('battle-screen').classList.add('active');
            
            document.getElementById('enemy-name').textContent = enemyName;
            document.getElementById('enemy-hp').textContent = `${enemy.hp}/${enemy.maxHp}`;
            
            const battleLog = document.getElementById('battle-log');
            
            if (enemyName === 'é…·é…·çš„ç‹—') {
                battleLog.innerHTML = `
                    <p>ä½ åœ¨é…·çŠ¬å±±çš„å±±é¡¶é‡åˆ°äº†ä¸€åªä½“å‹å·¨å¤§çš„æ€ªç‰©ï¼</p>
                    <p>å®ƒæœ‰ç€é£˜é€¸çš„æ¯›å‘ï¼Œé…·ç‚«çš„å¤–å½¢ï¼Œæ­£æ˜¯ä¼ è¯´ä¸­çš„"é…·é…·çš„ç‹—"ï¼</p>
                    <p class="damage">ğŸ• é…·é…·çš„ç‹—å‘å‡ºäº†ä¸€å£°éœ‡å¤©çš„åšå«ï¼š"æ•¢å…¥ä¾µæˆ‘çš„é¢†åœ°ï¼Ÿå°å°æˆ‘çš„æ€’ç«ï¼"</p>
                `;
            } else {
                battleLog.innerHTML = `<p>åœ¨ ${location.name} ä¸­ï¼Œä½ é­é‡äº† ${enemyName}ï¼</p>`;
            }

            document.getElementById('attack-btn').disabled = false;
            document.getElementById('heal-btn').disabled = false;
            document.getElementById('flee-btn').disabled = false;
        }

        // å¼€å§‹Bossæˆ˜æ–—
        function startBossBattle() {
            gameState.currentEnemy = JSON.parse(JSON.stringify(bossEnemy));
            gameState.inBattle = true;
            gameState.battleEnded = false;
            gameState.player.isZhenJi = false;
            
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('battle-screen').classList.add('active');
            
            document.getElementById('enemy-name').textContent = bossEnemy.name;
            document.getElementById('enemy-hp').textContent = `${bossEnemy.hp}/${bossEnemy.maxHp}`;
            
            const battleLog = document.getElementById('battle-log');
            battleLog.innerHTML = `
                <p>ä½ è¸å…¥äº†æ°¸å¤œå ¡å’ï¼Œåˆºéª¨çš„å¯’é£è¿é¢å¹æ¥ã€‚</p>
                <p>é˜´æ£®çš„å…‰çº¿ç…§äº®äº†å‘¨å›´ã€‚æœ€ä¸­å¤®çš„ç‹åº§ä¸Šï¼Œåç€é‚£ä¸ªä»¤äººææƒ§çš„èº«å½±â€”â€”çš±çš®å¤§ç‹ï¼</p>
                <p>å®ƒçš„èº«èº¯åºå¤§æ— æ¯”ï¼Œå……æ»¡äº†é‚ªæ¶çš„åŠ›é‡ã€‚æ— æ•°çµé­‚åœ¨å®ƒå‘¨å›´å“­å–Šã€‚</p>
                <p class="damage" style="color: #ff1744;">çš±çš®å¤§ç‹å‘å‡ºäº†éœ‡å¤©çš„æ€’å¼ï¼š"åˆæœ‰ä¸€ä¸ªå‡¡äººæ•¢æ¥æŒ‘æˆ˜æˆ‘ï¼Ÿä½ ä»¬éƒ½ä¼šæ²¦ä¸ºæˆ‘çš„å…»åˆ†ï¼"</p>
            `;

            document.getElementById('attack-btn').disabled = false;
            document.getElementById('heal-btn').disabled = false;
            document.getElementById('flee-btn').disabled = false;
        }

        // æ”»å‡»
        function attack() {
            if (!gameState.inBattle || !gameState.currentEnemy || gameState.battleEnded) return;
            
            const enemy = gameState.currentEnemy;
            const player = gameState.player;
            const battleLog = document.getElementById('battle-log');
            
            let playerDamage = player.baseAttack + player.bonusAttack + player.attackBoost - enemy.defense;
            playerDamage = Math.max(1, playerDamage);
            
            // è¯¸å¤©æœªæ¥ä»™å¸ç‰¹æ®Šèƒ½åŠ›
            if (player.name === 'è¯¸å¤©æœªæ¥ä»™å¸') {
                playerDamage = Math.floor(playerDamage * 1.2);
            }
            
            // âœ… ç›˜åœ£ç‰¹æ®Šèƒ½åŠ›ï¼šéœ‡æœº
            let isZhenJi = false;
            if (player.name === 'ç›˜åœ£' && Math.random() < 0.35) {
                isZhenJi = true;
                playerDamage *= 2;
                battleLog.innerHTML += `<p class="damage">âš¡ è§¦å‘"éœ‡æœº"ï¼æœ¬è½®ä¼¤å®³æé«˜100%ï¼Œé€ æˆ ${playerDamage} ç‚¹ä¼¤å®³ï¼</p>`;
            } else if (player.name === 'å› æç“¦ç‰¹Â·è§') {
                playerDamage = Math.floor(playerDamage * 1.3);
            } else if (player.name === 'é¬¼å§¥' && Math.random() < 0.3) {
                playerDamage *= 2;
                battleLog.innerHTML += `<p class="damage">ğŸ’€ è‡´å‘½ä¸€å‡»ï¼é€ æˆ ${playerDamage} ç‚¹ä¼¤å®³ï¼</p>`;
            } else if (player.name !== 'ç›˜åœ£' && player.name !== 'å› æç“¦ç‰¹Â·è§' && player.name !== 'é¬¼å§¥') {
                battleLog.innerHTML += `<p class="damage">âš”ï¸ ä½ æ”»å‡»äº† ${enemy.name}ï¼Œé€ æˆ ${playerDamage} ç‚¹ä¼¤å®³</p>`;
            }
            
            if (player.name !== 'ç›˜åœ£' && player.name !== 'é¬¼å§¥' && player.name !== 'å› æç“¦ç‰¹Â·è§') {
                battleLog.innerHTML += `<p class="damage">âš”ï¸ ä½ æ”»å‡»äº† ${enemy.name}ï¼Œé€ æˆ ${playerDamage} ç‚¹ä¼¤å®³</p>`;
            }
            
            enemy.hp -= playerDamage;
            
            if (enemy.hp <= 0) {
                enemy.hp = 0;
                gameState.battleEnded = true;
                
                battleLog.innerHTML += `<p class="heal">ğŸ‰ ä½ å‡»è´¥äº† ${enemy.name}ï¼</p>`;
                
                document.getElementById('attack-btn').disabled = true;
                document.getElementById('heal-btn').disabled = true;
                document.getElementById('flee-btn').disabled = true;
                
                if (enemy.name === 'çš±çš®å¤§ç‹') {
                    gameState.bossDefeated = true;
                    setTimeout(() => {
                        gameOver(true);
                    }, 2000);
                } else if (enemy.name === 'é…·é…·çš„ç‹—') {
                    gameState.defeatedCoolDog = true;
                    enemy.reward.forEach(itemId => {
                        const amount = Math.floor(Math.random() * 2) + 1;
                        addToInventory(itemId, amount);
                        battleLog.innerHTML += `<p class="heal">è·å¾— ${items[itemId].name} x${amount}</p>`;
                    });
                    battleLog.innerHTML += `<p class="heal">ğŸ’ é…·é…·çš„ç‹—æ‰è½äº†å®è´µçš„çµé­‚ç¢ç‰‡ï¼</p>`;
                    setTimeout(() => {
                        endBattle();
                    }, 2000);
                } else {
                    enemy.reward.forEach(itemId => {
                        const amount = Math.floor(Math.random() * 2) + 1;
                        addToInventory(itemId, amount);
                        battleLog.innerHTML += `<p class="heal">è·å¾— ${items[itemId].name} x${amount}</p>`;
                    });
                    
                    setTimeout(() => {
                        endBattle();
                    }, 2000);
                }
                
                document.getElementById('enemy-hp').textContent = `0/${enemy.maxHp}`;
                battleLog.scrollTop = battleLog.scrollHeight;
                return;
            }
            
            // æ•Œäººåå‡»
            let enemyDamage = enemy.attack - (player.baseDefense + player.bonusDefense);
            enemyDamage = Math.max(1, enemyDamage);
            
            if (enemy.name === 'çš±çš®å¤§ç‹' && Math.random() < 0.3) {
                enemyDamage = Math.floor(enemyDamage * 2);
                battleLog.innerHTML += `<p class="damage">ğŸŒ‘ çš±çš®å¤§ç‹ä½¿ç”¨äº†é‚ªæ¶èƒ½é‡ï¼Œé€ æˆ ${enemyDamage} ç‚¹ä¼¤å®³ï¼</p>`;
            } else if (enemy.name === 'é…·é…·çš„ç‹—' && Math.random() < 0.25) {
                enemyDamage = Math.floor(enemyDamage * 1.8);
                battleLog.innerHTML += `<p class="damage">ğŸ• é…·é…·çš„ç‹—å±•ç°å‡ºäº†å®ƒçš„é…·ç‚«åŠ›é‡ï¼Œé€ æˆ ${enemyDamage} ç‚¹ä¼¤å®³ï¼</p>`;
            }
            
            if (player.name === 'åˆ˜ä¸–é¹') {
                enemyDamage = Math.floor(enemyDamage * 0.7);
            }
            
            // âœ… ç¥ç›¾ç‰¹æ®Šèƒ½åŠ›ï¼šå—ä¼¤æ—¶æ”»å‡»åŠ›æå‡
            const actualDamage = enemyDamage;
            
            const dodgeChance = (player.agility || 0) / 100 + (player.name === 'ç™½ç‹' ? 0.25 : 0);
            if (Math.random() < dodgeChance) {
                battleLog.innerHTML += `<p class="heal">âœ¨ ä½ çµå·§åœ°é—ªé¿äº†æ”»å‡»ï¼</p>`;
            } else {
                player.hp -= actualDamage;
                
                // âœ… ç¥ç›¾å—ä¼¤åæ”»å‡»åŠ›æå‡
                if (player.name === 'ç¥ç›¾' && actualDamage > 0) {
                    const boost = Math.floor((player.baseAttack + player.bonusAttack) * 0.05);
                    player.attackBoost += boost;
                    battleLog.innerHTML += `<p class="info">ğŸ›¡ï¸ å—ä¼¤æ¿€å‘æ½œèƒ½ï¼æ”»å‡»åŠ›æå‡ ${boost} ç‚¹ï¼ˆæ€»è®¡ï¼š${player.baseAttack + player.bonusAttack + player.attackBoost}ï¼‰</p>`;
                }
                
                battleLog.innerHTML += `<p class="damage">ğŸ’¥ ${enemy.name} åå‡»ï¼Œé€ æˆ ${actualDamage} ç‚¹ä¼¤å®³</p>`;
            }
            
            document.getElementById('enemy-hp').textContent = `${enemy.hp}/${enemy.maxHp}`;
            updateStatusBar();
            battleLog.scrollTop = battleLog.scrollHeight;
            
            if (player.hp <= 0) {
                gameState.battleEnded = true;
                document.getElementById('attack-btn').disabled = true;
                document.getElementById('heal-btn').disabled = true;
                document.getElementById('flee-btn').disabled = true;
                setTimeout(() => {
                    gameOver(false);
                }, 1000);
            }
        }

        // æˆ˜æ–—ä¸­ä½¿ç”¨æ²»ç–—
        function useHealItem() {
            if (!gameState.inBattle || gameState.battleEnded) return;
            
            const healItems = ['herb', 'potion', 'meat'];
            let used = false;
            
            for (let itemId of healItems) {
                if (gameState.inventory[itemId] && gameState.inventory[itemId] > 0) {
                    useItem(itemId);
                    
                    const battleLog = document.getElementById('battle-log');
                    battleLog.innerHTML += `<p class="heal">ğŸ’Š ä½¿ç”¨äº† ${items[itemId].name}</p>`;
                    
                    const enemy = gameState.currentEnemy;
                    let enemyDamage = enemy.attack - (gameState.player.baseDefense + gameState.player.bonusDefense);
                    enemyDamage = Math.max(1, enemyDamage);
                    
                    if (gameState.player.name === 'åˆ˜ä¸–é¹') {
                        enemyDamage = Math.floor(enemyDamage * 0.7);
                    }
                    
                    const dodgeChance = (gameState.player.agility || 0) / 100 + (gameState.player.name === 'ç™½ç‹' ? 0.25 : 0);
                    if (Math.random() < dodgeChance) {
                        battleLog.innerHTML += `<p class="heal">âœ¨ ä½ é—ªé¿äº†æ”»å‡»ï¼</p>`;
                    } else {
                        gameState.player.hp -= enemyDamage;
                        if (gameState.player.name === 'ç¥ç›¾' && enemyDamage > 0) {
                            const boost = Math.floor((gameState.player.baseAttack + gameState.player.bonusAttack) * 0.05);
                            gameState.player.attackBoost += boost;
                            battleLog.innerHTML += `<p class="info">ğŸ›¡ï¸ å—ä¼¤æ¿€å‘æ½œèƒ½ï¼æ”»å‡»åŠ›æå‡ ${boost} ç‚¹</p>`;
                        }
                        battleLog.innerHTML += `<p class="damage">ğŸ’¥ ${enemy.name} è¶æœºæ”»å‡»ï¼Œé€ æˆ ${enemyDamage} ç‚¹ä¼¤å®³</p>`;
                    }
                    
                    updateStatusBar();
                    battleLog.scrollTop = battleLog.scrollHeight;
                    used = true;
                    break;
                }
            }
            
            if (!used) {
                const battleLog = document.getElementById('battle-log');
                battleLog.innerHTML += `<p>âŒ æ²¡æœ‰å¯ç”¨çš„æ²»ç–—ç‰©å“ï¼</p>`;
            }
        }

        // é€ƒè·‘
        function flee() {
            if (!gameState.inBattle || gameState.battleEnded) return;
            
            if (gameState.currentEnemy.name === 'çš±çš®å¤§ç‹') {
                const battleLog = document.getElementById('battle-log');
                battleLog.innerHTML += `<p class="damage">âš ï¸ æ— æ³•ä»çš±çš®å¤§ç‹é¢å‰é€ƒè·‘ï¼å®ƒçš„åŠ›é‡å®Œå…¨å°é”äº†è¿™ä¸ªç©ºé—´ï¼</p>`;
                return;
            }
            
            if (Math.random() < 0.6) {
                gameState.battleEnded = true;
                const battleLog = document.getElementById('battle-log');
                battleLog.innerHTML += `<p class="heal">ğŸƒ ä½ æˆåŠŸé€ƒè·‘äº†ï¼</p>`;
                
                document.getElementById('attack-btn').disabled = true;
                document.getElementById('heal-btn').disabled = true;
                document.getElementById('flee-btn').disabled = true;
                
                setTimeout(() => {
                    endBattle();
                }, 1000);
            } else {
                const battleLog = document.getElementById('battle-log');
                battleLog.innerHTML += `<p class="damage">âŒ é€ƒè·‘å¤±è´¥ï¼</p>`;
                
                const enemy = gameState.currentEnemy;
                let enemyDamage = enemy.attack - (gameState.player.baseDefense + gameState.player.bonusDefense);
                enemyDamage = Math.max(1, enemyDamage);
                
                if (gameState.player.name === 'åˆ˜ä¸–é¹') {
                    enemyDamage = Math.floor(enemyDamage * 0.7);
                }
                
                gameState.player.hp -= enemyDamage;
                if (gameState.player.name === 'ç¥ç›¾' && enemyDamage > 0) {
                    const boost = Math.floor((gameState.player.baseAttack + gameState.player.bonusAttack) * 0.05);
                    gameState.player.attackBoost += boost;
                    battleLog.innerHTML += `<p class="info">ğŸ›¡ï¸ å—ä¼¤æ¿€å‘æ½œèƒ½ï¼æ”»å‡»åŠ›æå‡ ${boost} ç‚¹</p>`;
                }
                battleLog.innerHTML += `<p class="damage">ğŸ’¥ ${enemy.name} è¿½å‡»ï¼Œé€ æˆ ${enemyDamage} ç‚¹ä¼¤å®³</p>`;
                updateStatusBar();
            }
        }

        // ç»“æŸæˆ˜æ–—
        function endBattle() {
            gameState.inBattle = false;
            gameState.currentEnemy = null;
            gameState.battleEnded = false;
            gameState.player.attackBoost = 0;  // âœ… é‡ç½®ç¥ç›¾æ”»å‡»åŠ æˆ
            
            document.getElementById('battle-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            addGameLog('æˆ˜æ–—ç»“æŸï¼Œä½ ç»§ç»­å‰è¿›...');
        }

        // è¿”å›æ¸¸æˆ
        function backToGame() {
            document.getElementById('inventory-screen').classList.remove('active');
            document.getElementById('craft-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
        }

        // æ·»åŠ åˆ°èƒŒåŒ…
        function addToInventory(itemId, amount) {
            if (!gameState.inventory[itemId]) {
                gameState.inventory[itemId] = 0;
            }
            gameState.inventory[itemId] += amount;
        }

        // æ£€æŸ¥ç”Ÿå­˜çŠ¶æ€
        function checkSurvival() {
            if (gameState.player.hunger <= 0) {
                gameState.player.hp -= 10;
                addGameLog('âš ï¸ ä½ å¤ªé¥¿äº†ï¼ŒæŸå¤±äº†10ç‚¹ç”Ÿå‘½å€¼ï¼');
            }
            
            if (gameState.player.thirst <= 0) {
                gameState.player.hp -= 15;
                addGameLog('âš ï¸ ä½ å£æ¸´éš¾è€ï¼ŒæŸå¤±äº†15ç‚¹ç”Ÿå‘½å€¼ï¼');
            }
            
            updateStatusBar();
        }

        // æ¸¸æˆç»“æŸ
        function gameOver(victory) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('ending-screen').classList.add('active');
            
            const endingContent = document.getElementById('ending-content');
            
            if (victory) {
                endingContent.innerHTML = `
                    <h2 class="victory">ğŸŠ çœŸÂ·ç»“å±€ï¼šå¤ä»‡å®Œæˆ ğŸŠ</h2>
                    <p style="margin-bottom: 20px; color: #ffd54f;">
                        çš±çš®å¤§ç‹å‘å‡ºæœ€åçš„æƒ¨å«å£°ï¼Œé‚ªæ¶çš„åŠ›é‡ä»å®ƒä½“å†…æ¶ˆæ•£ã€‚<br>
                        åºå¤§çš„èº«èº¯è½°ç„¶å€’åœ°ï¼Œæ°¸å¤œå ¡å’å¼€å§‹å´©å¡Œï¼
                    </p>
                    <p style="margin-bottom: 20px;">
                        é»‘æš—è¢«å…‰æ˜é©±æ•£ï¼Œè¢«ç¦é”¢çš„çµé­‚è·å¾—äº†è§£è„±ã€‚<br>
                        ä½ ç«™åœ¨åºŸå¢Ÿä¸­ï¼Œç»ˆäºä¸ºä»™å®¶å†›çš„æ‰€æœ‰äººå¤äº†ä»‡ã€‚
                    </p>
                    <p style="margin-bottom: 20px;">
                        è™½ç„¶å®¶å›­å·²ç»æ— æ³•é‡å»ºï¼Œä½†çš±çš®å¤§ç‹çš„å¨èƒå½»åº•æ¶ˆé™¤äº†ã€‚<br>
                        æ–°çš„æ—¶ä»£å³å°†å¼€å§‹...
                    </p>
                    <p style="margin-bottom: 20px;">
                        ä½ çš„çœ¼ä¸­é—ªçƒç€æ³ªå…‰ã€‚åœ¨é£ä¸­ï¼Œä½ ä¼¼ä¹å¬åˆ°äº†æ‰€æœ‰å¤±å»çš„åŒä¼´åœ¨æ­Œå”±...
                    </p>
                    <div style="background: rgba(76, 175, 80, 0.2); padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p style="color: #4caf50;"><strong>æ¸¸æˆç»Ÿè®¡</strong></p>
                        <p>è§’è‰²: ${gameState.player.name}</p>
                        <p>å­˜æ´»å›åˆ: ${gameState.turnsAlived}</p>
                        <p>è®¿é—®åœ°ç‚¹: ${gameState.visitedLocations.size} ä¸ª</p>
                        <p>æœ€ç»ˆæ”»å‡»åŠ›: ${gameState.player.baseAttack + gameState.player.bonusAttack}</p>
                        <p>æœ€ç»ˆé˜²å¾¡åŠ›: ${gameState.player.baseDefense + gameState.player.bonusDefense}</p>
                    </div>
                    <button class="btn btn-primary" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
                `;
            } else {
                endingContent.innerHTML = `
                    <h2 class="defeat">ğŸ’€ æ¸¸æˆç»“æŸ ğŸ’€</h2>
                    <p style="margin-bottom: 20px;">
                        ä½ çš„ç”Ÿå‘½å€¼å½’é›¶äº†...<br>
                        å¤ä»‡ä¹‹è·¯åˆ°æ­¤ä¸ºæ­¢ã€‚
                    </p>
                    <p style="color: #f44336; margin-bottom: 20px;">
                        ä½†æ˜¯ï¼Œä»™å®¶å†›çš„æ„å¿—ä¸ä¼šæ¶ˆäº¡ï¼<br>
                        æ€»ä¼šæœ‰äººç»§ç»­æˆ˜æ–—ä¸‹å»...
                    </p>
                    <div style="background: rgba(244, 67, 54, 0.2); padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p style="color: #f44336;"><strong>æ¸¸æˆç»Ÿè®¡</strong></p>
                        <p>è§’è‰²: ${gameState.player.name}</p>
                        <p>å­˜æ´»å›åˆ: ${gameState.turnsAlived}</p>
                        <p>è®¿é—®åœ°ç‚¹: ${gameState.visitedLocations.size} ä¸ª</p>
                        <p>æœ€åä½ç½®: ${locations.find(l => l.id === gameState.currentLocation).name}</p>
                    </div>
                    <button class="btn btn-danger" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initCharacterSelection();
        };
    </script>
</body>
</html>
